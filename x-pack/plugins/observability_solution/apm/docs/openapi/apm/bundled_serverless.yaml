openapi: 3.0.0
info:
  title: APM UI
  version: 1.0.0
  description: Kibana APIs for working with the APM UI.
  license:
    name: Elastic License 2.0
    url: https://www.elastic.co/licensing/elastic-license
tags:
  - name: APM agent keys
    description: |
      Configure APM agent keys to authorize requests from APM agents to the APM Server.
    externalDocs:
      description: APM agent API key docs
      url: https://www.elastic.co/docs/current/serverless/observability/apm-keep-data-secure#secure-communication-with-apm-agents
  - name: APM annotations
    description: |
      Annotate visualizations in the APM UI with significant events. Annotations enable you to easily see how events are impacting the performance of your applications.
    externalDocs:
      description: APM annotations docs
      url: https://www.elastic.co/docs/current/serverless/observability/apm-track-deployments-with-annotations
paths:
  /api/apm/agent_keys:
    post:
      summary: Create an APM agent key
      description: |
        Create an APM agent API key.
        Specify API key privileges in the request body at creation time.

        You must have at least the `manage_own_api_key` cluster privilege and the APM application-level privileges that it wishes to grant.
      operationId: createAgentKey
      tags:
        - APM agent keys
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  description: The name of the APM agent key.
                  type: string
                  example: my-new-apm-key
                privileges:
                  description: |
                    APM agent key privileges. It can take one or more of the following values:

                    * `event:write`: Required for ingesting APM agent events.
                    * `config_agent:read`: Required for APM agents to read agent configuration remotely.
                  type: array
                  items:
                    type: string
                    enum:
                      - event:write
                      - config_agent:read
                  example:
                    - event:write
                    - config_agent:read
              required:
                - name
                - privileges
      responses:
        '200':
          description: The agent key was created successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  api_key:
                    type: string
                    example: PjGloCGOTzaZr8ilUPvkjA
                  expiration:
                    type: integer
                    format: int64
                  id:
                    type: string
                    example: 3DCLmn0B3ZMhLUa7WBG9
                  name:
                    type: string
                    example: my-new-apm-key
                  encoded:
                    type: string
                    example: M0RDTG1uMEIzWk1oTFVhN1dCRzk6UGpHbG9DR09UemFacjhpbFVQdmtqQQ
  /api/apm/services/{serviceName}/annotation:
    post:
      summary: Create or update an annotation
      description: |
        Create a new annotation for a specific service.
        By default, annotations are stored in a newly created `observability-annotations` index.
        The name of this index can be changed in your `config.yml` by editing `xpack.observability.annotations.index`.
        If you change the default index name, youâ€™ll also need to update your [user privileges](https://www.elastic.co/guide/en/observability/current/apm-app-annotation-user-create.html) accordingly.
      operationId: createAnnotation
      tags:
        - APM annotations
      parameters:
        - name: serviceName
          in: path
          required: true
          description: The name of the service.
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                service:
                  type: object
                  description: Service identifying the configuration to create or update.
                  properties:
                    version:
                      type: string
                      description: Version of service.
                      example: '1.2'
                    environment:
                      type: string
                      description: Environment of service.
                      example: production
                  required:
                    - version
                '@timestamp':
                  type: string
                  description: |
                    The date and time of the annotation.
                    Must be in [ISO 8601](https://www.w3.org/TR/NOTE-datetime) format.
                  example: '2024-07-21T10:31:30.452Z'
                message:
                  type: string
                  description: The message displayed in the annotation.
                  example: Deployment 1.2
                  default: service.version
                tags:
                  type: array
                  description: |
                    Distinguish APM annotations from other annotations.
                    Defaults to `["apm"]`, and while you can add additional tags, you cannot remove the `apm` tag.
                  items:
                    type: string
                  default:
                    - apm
                  example:
                    - apm
                    - my-tag
              required:
                - '@timestamp'
                - service
      responses:
        '200':
          description: Annotation created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  _index:
                    type: string
                    example: observability-annotations
                  _id:
                    type: string
                    example: Lc9I93EBh6DbmkeV7nFX
                  _version:
                    type: integer
                    example: 1
                  _seq_no:
                    type: integer
                    example: 0
                  _primary_term:
                    type: integer
                    example: 1
                  found:
                    type: boolean
                    example: true
                  _source:
                    type: object
                    properties:
                      message:
                        type: string
                        example: Deployment 1.2
                      '@timestamp':
                        type: string
                        example: '2024-07-21T10:31:30.452Z'
                      service:
                        type: object
                        properties:
                          version:
                            type: string
                            example: '1.2'
                          name:
                            type: string
                            example: my-node-service
                          environment:
                            type: string
                      annotation:
                        type: object
                        properties:
                          type:
                            type: string
                            example: deployment
                      tags:
                        type: array
                        items:
                          type: string
                        example:
                          - apm
                          - elastic.co
                          - customer
                      event:
                        type: object
                        properties:
                          created:
                            type: string
                            example: '2024-08-30T15:46:43.259Z'
  /api/apm/services/{serviceName}/annotation/search:
    get:
      summary: Search for annotations
      description: Search for annotations related to a specific service.
      operationId: getAnnotation
      tags:
        - APM annotations
      parameters:
        - name: serviceName
          in: path
          required: true
          description: The name of the service.
          schema:
            type: string
        - name: environment
          in: query
          required: false
          description: The environment to filter annotations by.
          schema:
            type: string
        - name: start
          in: query
          required: false
          description: The start date for the search.
          schema:
            type: string
        - name: end
          in: query
          required: false
          description: The end date for the search.
          schema:
            type: string
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  annotations:
                    type: array
                    items:
                      type: object
                      properties:
                        type:
                          type: string
                          enum:
                            - version
                        id:
                          type: string
                        '@timestamp':
                          type: number
                          example: 1721557890452
                        text:
                          type: string
                          example: Deployment 1.2
components: {}
